AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  Herald - MCP Server for S3 File Publishing
  OAuth 2.1 with PKCE, Streamable HTTP transport, S3 file uploads
  Uses shared VPC infrastructure from Maven

Globals:
  Function:
    Timeout: 120
    MemorySize: 1024
    Architectures:
      - arm64
    Environment:
      Variables:
        LOG_LEVEL: INFO
        ENVIRONMENT: !Ref Environment
        AURORA_SECRET_ARN: !Ref AuroraSecret
        AURORA_CLUSTER_ARN: !GetAtt AuroraCluster.DBClusterArn
        AURORA_DATABASE: herald

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - staging
      - prod

  AuroraMinCapacity:
    Type: Number
    Default: 0.5
    Description: Minimum ACUs for Aurora Serverless v2

  AuroraMaxCapacity:
    Type: Number
    Default: 4
    Description: Maximum ACUs for Aurora Serverless v2

  # Import Maven VPC resources via SSM parameters
  MavenVpcId:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /maven/dev/vpc-id

  MavenPrivateSubnet1:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /maven/dev/private-subnet-1

  MavenPrivateSubnet2:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /maven/dev/private-subnet-2

  MavenDBSubnetGroup:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /maven/dev/db-subnet-group

  MavenLambdaSecurityGroup:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /maven/dev/lambda-sg

  MavenBastionSecurityGroup:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /maven/dev/bastion-sg

Resources:
  #############################################################################
  # Security Groups (Herald-specific, references Maven's SGs for ingress)
  #############################################################################
  AuroraSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Herald Aurora cluster
      VpcId: !Ref MavenVpcId
      Tags:
        - Key: Name
          Value: !Sub herald-${Environment}-aurora-sg

  # Allow Maven's Lambda SG to access Herald Aurora
  AuroraSecurityGroupLambdaIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref AuroraSecurityGroup
      IpProtocol: tcp
      FromPort: 5432
      ToPort: 5432
      SourceSecurityGroupId: !Ref MavenLambdaSecurityGroup

  # Allow Maven's Bastion SG to access Herald Aurora
  AuroraSecurityGroupBastionIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref AuroraSecurityGroup
      IpProtocol: tcp
      FromPort: 5432
      ToPort: 5432
      SourceSecurityGroupId: !Ref MavenBastionSecurityGroup

  #############################################################################
  # Aurora Serverless v2
  #############################################################################
  AuroraSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub herald-${Environment}-aurora-credentials
      Description: Aurora credentials for Herald
      GenerateSecretString:
        SecretStringTemplate: '{"username": "herald_admin"}'
        GenerateStringKey: password
        PasswordLength: 32
        ExcludeCharacters: '"@/\'

  AuroraCluster:
    Type: AWS::RDS::DBCluster
    Properties:
      DBClusterIdentifier: !Sub herald-${Environment}-cluster
      Engine: aurora-postgresql
      EngineVersion: '16.4'
      Port: 5432
      DatabaseName: herald
      MasterUsername: !Sub '{{resolve:secretsmanager:${AuroraSecret}:SecretString:username}}'
      MasterUserPassword: !Sub '{{resolve:secretsmanager:${AuroraSecret}:SecretString:password}}'
      ServerlessV2ScalingConfiguration:
        MinCapacity: !Ref AuroraMinCapacity
        MaxCapacity: !Ref AuroraMaxCapacity
      DBSubnetGroupName: !Ref MavenDBSubnetGroup
      VpcSecurityGroupIds:
        - !Ref AuroraSecurityGroup
      EnableHttpEndpoint: true
      StorageEncrypted: true
      Tags:
        - Key: Name
          Value: !Sub herald-${Environment}-cluster

  AuroraInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub herald-${Environment}-instance-1
      DBClusterIdentifier: !Ref AuroraCluster
      DBInstanceClass: db.serverless
      Engine: aurora-postgresql
      PubliclyAccessible: false
      Tags:
        - Key: Name
          Value: !Sub herald-${Environment}-instance-1

  AuroraSecretAttachment:
    Type: AWS::SecretsManager::SecretTargetAttachment
    Properties:
      SecretId: !Ref AuroraSecret
      TargetId: !Ref AuroraCluster
      TargetType: AWS::RDS::DBCluster

  #############################################################################
  # API Gateway
  #############################################################################
  ApiGateway:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName: $default
      DisableExecuteApiEndpoint: false
      CorsConfiguration:
        AllowOrigins:
          - "*"
        AllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        AllowHeaders:
          - Content-Type
          - Authorization
          - Mcp-Session-Id
        ExposeHeaders:
          - Mcp-Session-Id

  #############################################################################
  # Lambda Functions
  #############################################################################

  # OAuth Server Function
  OAuthFunction:
    Type: AWS::Serverless::Function
    Properties:
      PackageType: Image
      ImageConfig:
        Command:
          - oauth.server.handler
      Description: OAuth 2.1 server (DCR, authorize, token, metadata)
      VpcConfig:
        SecurityGroupIds:
          - !Ref MavenLambdaSecurityGroup
        SubnetIds:
          - !Ref MavenPrivateSubnet1
          - !Ref MavenPrivateSubnet2
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource:
                - !Ref AuroraSecret
            - Effect: Allow
              Action:
                - rds-data:ExecuteStatement
                - rds-data:BatchExecuteStatement
              Resource: !GetAtt AuroraCluster.DBClusterArn
      Events:
        OAuthMetadata:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /.well-known/oauth-authorization-server
            Method: GET
        OAuthProtectedResource:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /.well-known/oauth-protected-resource
            Method: GET
        OAuthRegister:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /oauth/register
            Method: POST
        OAuthAuthorize:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /oauth/authorize
            Method: GET
        OAuthAuthorizePost:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /oauth/authorize
            Method: POST
        OAuthToken:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /oauth/token
            Method: POST
        AuthorizeGet:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /authorize
            Method: GET
        AuthorizePost:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /authorize
            Method: POST
        Token:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /token
            Method: POST
        OAuthUserInfo:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /oauth/userinfo
            Method: GET
        TenantSignup:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /signup
            Method: POST
        TenantLogin:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /login
            Method: POST
    Metadata:
      DockerContext: .
      Dockerfile: Dockerfile
      DockerTag: !Ref Environment

  # Tenant Admin Function
  TenantAdminFunction:
    Type: AWS::Serverless::Function
    Properties:
      PackageType: Image
      ImageConfig:
        Command:
          - admin.tenant.handler
      Description: Tenant admin API (OAuth authenticated)
      Timeout: 300
      FunctionUrlConfig:
        AuthType: NONE
        Cors:
          AllowOrigins:
            - "*"
          AllowMethods:
            - GET
            - POST
            - PUT
            - DELETE
          AllowHeaders:
            - Content-Type
            - Authorization
          MaxAge: 86400
      VpcConfig:
        SecurityGroupIds:
          - !Ref MavenLambdaSecurityGroup
        SubnetIds:
          - !Ref MavenPrivateSubnet1
          - !Ref MavenPrivateSubnet2
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
                - secretsmanager:CreateSecret
                - secretsmanager:PutSecretValue
                - secretsmanager:DescribeSecret
                - secretsmanager:DeleteSecret
              Resource:
                - !Ref AuroraSecret
                - !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:herald-${Environment}-bucket-*
            - Effect: Allow
              Action:
                - rds-data:ExecuteStatement
                - rds-data:BatchExecuteStatement
              Resource: !GetAtt AuroraCluster.DBClusterArn
      Events:
        AdminListBuckets:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /api/admin/buckets
            Method: GET
        AdminGetBucket:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /api/admin/buckets/{bucket_id}
            Method: GET
        AdminCreateBucket:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /api/admin/buckets
            Method: POST
        AdminUpdateBucket:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /api/admin/buckets/{bucket_id}
            Method: PUT
        AdminDeleteBucket:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /api/admin/buckets/{bucket_id}
            Method: DELETE
        AdminListBucketFiles:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /api/admin/buckets/{bucket_id}/files
            Method: GET
        AdminListAccessGrants:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /api/admin/buckets/{bucket_id}/access
            Method: GET
        AdminCreateAccessGrant:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /api/admin/buckets/{bucket_id}/access
            Method: POST
        AdminDeleteAccessGrant:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /api/admin/buckets/{bucket_id}/access/{grant_id}
            Method: DELETE
        AdminListUsers:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /api/admin/users
            Method: GET
        AdminCreateUser:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /api/admin/users
            Method: POST
        AdminUpdateUser:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /api/admin/users/{user_id}
            Method: PUT
        AdminDeleteUser:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /api/admin/users/{user_id}
            Method: DELETE
        AdminListUploads:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /api/admin/uploads
            Method: GET
        AdminGetStats:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /api/admin/stats
            Method: GET
    Metadata:
      DockerContext: .
      Dockerfile: Dockerfile
      DockerTag: !Ref Environment

  # MCP Server Function
  McpFunction:
    Type: AWS::Serverless::Function
    Properties:
      PackageType: Image
      ImageConfig:
        Command:
          - mcp.server.handler
      Description: MCP server for S3 file publishing
      MemorySize: 1024
      Timeout: 300
      VpcConfig:
        SecurityGroupIds:
          - !Ref MavenLambdaSecurityGroup
        SubnetIds:
          - !Ref MavenPrivateSubnet1
          - !Ref MavenPrivateSubnet2
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource:
                - !Ref AuroraSecret
                - !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:herald-${Environment}-bucket-*
            - Effect: Allow
              Action:
                - rds-data:ExecuteStatement
                - rds-data:BatchExecuteStatement
              Resource: !GetAtt AuroraCluster.DBClusterArn
            - Effect: Allow
              Action:
                - s3:GetObject
                - s3:PutObject
                - s3:DeleteObject
                - s3:ListBucket
              Resource: '*'
            - Effect: Allow
              Action:
                - sts:AssumeRole
              Resource: '*'
      Events:
        McpEndpoint:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /mcp
            Method: POST
        McpSession:
          Type: HttpApi
          Properties:
            ApiId: !Ref ApiGateway
            Path: /mcp
            Method: GET
    Metadata:
      DockerContext: .
      Dockerfile: Dockerfile
      DockerTag: !Ref Environment

  # Database Migration Function
  MigrationFunction:
    Type: AWS::Serverless::Function
    Properties:
      PackageType: Image
      ImageConfig:
        Command:
          - migrate.handler
      Description: Database migration runner
      Timeout: 300
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource:
                - !Ref AuroraSecret
            - Effect: Allow
              Action:
                - rds-data:ExecuteStatement
                - rds-data:BatchExecuteStatement
              Resource: !GetAtt AuroraCluster.DBClusterArn
    Metadata:
      DockerContext: .
      Dockerfile: Dockerfile
      DockerTag: !Ref Environment

  #############################################################################
  # Platform Admin API (IAM Authentication)
  #############################################################################
  PlatformAdminApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub herald-${Environment}-platform-admin
      StageName: !Ref Environment
      Auth:
        DefaultAuthorizer: AWS_IAM
      Cors:
        AllowOrigin: "'*'"
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,Authorization,X-Amz-Date,X-Amz-Security-Token'"

  PlatformAdminFunction:
    Type: AWS::Serverless::Function
    Properties:
      PackageType: Image
      ImageConfig:
        Command:
          - admin.platform.handler
      Description: Platform admin API (IAM authenticated)
      VpcConfig:
        SecurityGroupIds:
          - !Ref MavenLambdaSecurityGroup
        SubnetIds:
          - !Ref MavenPrivateSubnet1
          - !Ref MavenPrivateSubnet2
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
                - secretsmanager:CreateSecret
                - secretsmanager:UpdateSecret
                - secretsmanager:DeleteSecret
              Resource:
                - !Ref AuroraSecret
                - !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:herald-${Environment}-*
            - Effect: Allow
              Action:
                - rds-data:ExecuteStatement
                - rds-data:BatchExecuteStatement
              Resource: !GetAtt AuroraCluster.DBClusterArn
      Events:
        ListTenants:
          Type: Api
          Properties:
            RestApiId: !Ref PlatformAdminApi
            Path: /tenants
            Method: GET
        GetTenant:
          Type: Api
          Properties:
            RestApiId: !Ref PlatformAdminApi
            Path: /tenants/{tenant_id}
            Method: GET
        CreateTenant:
          Type: Api
          Properties:
            RestApiId: !Ref PlatformAdminApi
            Path: /tenants
            Method: POST
        UpdateTenant:
          Type: Api
          Properties:
            RestApiId: !Ref PlatformAdminApi
            Path: /tenants/{tenant_id}
            Method: PUT
        DeleteTenant:
          Type: Api
          Properties:
            RestApiId: !Ref PlatformAdminApi
            Path: /tenants/{tenant_id}
            Method: DELETE
        GetMetrics:
          Type: Api
          Properties:
            RestApiId: !Ref PlatformAdminApi
            Path: /metrics
            Method: GET
    Metadata:
      DockerContext: .
      Dockerfile: Dockerfile
      DockerTag: !Ref Environment

  #############################################################################
  # Admin UI - S3 + CloudFront
  #############################################################################
  AdminUIBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub herald-${Environment}-admin-ui-${AWS::AccountId}
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      Tags:
        - Key: Name
          Value: !Sub herald-${Environment}-admin-ui

  AdminUIBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref AdminUIBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowCloudFrontOAC
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Sub ${AdminUIBucket.Arn}/*
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub arn:aws:cloudfront::${AWS::AccountId}:distribution/${AdminUIDistribution}

  AdminUIOAC:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub herald-${Environment}-admin-ui-oac
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  AdminUIDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        Comment: !Sub Herald Admin UI - ${Environment}
        DefaultRootObject: index.html
        HttpVersion: http2and3
        PriceClass: PriceClass_100
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt AdminUIBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: ''
            OriginAccessControlId: !Ref AdminUIOAC
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          CachedMethods:
            - GET
            - HEAD
          Compress: true
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6
          ResponseHeadersPolicyId: 5cc3b908-e619-4b99-88e5-2cf7f45965bd
        CustomErrorResponses:
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 0
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 0
      Tags:
        - Key: Name
          Value: !Sub herald-${Environment}-admin-ui

#############################################################################
# Outputs
#############################################################################
Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value: !Sub "https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com"
    Export:
      Name: !Sub herald-${Environment}-api-endpoint

  McpServerUrl:
    Description: MCP Server URL for Claude
    Value: !Sub "https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/mcp"
    Export:
      Name: !Sub herald-${Environment}-mcp-url

  OAuthMetadataUrl:
    Description: OAuth Authorization Server Metadata URL
    Value: !Sub "https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/.well-known/oauth-authorization-server"
    Export:
      Name: !Sub herald-${Environment}-oauth-metadata

  AuroraClusterArn:
    Description: Aurora cluster ARN
    Value: !GetAtt AuroraCluster.DBClusterArn
    Export:
      Name: !Sub herald-${Environment}-aurora-arn

  AuroraSecretArn:
    Description: Aurora credentials secret ARN
    Value: !Ref AuroraSecret
    Export:
      Name: !Sub herald-${Environment}-aurora-secret

  PlatformAdminApiUrl:
    Description: Platform Admin API URL (IAM authenticated)
    Value: !Sub "https://${PlatformAdminApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}"
    Export:
      Name: !Sub herald-${Environment}-platform-admin-api

  AdminUIBucketName:
    Description: S3 bucket for Admin UI static files
    Value: !Ref AdminUIBucket
    Export:
      Name: !Sub herald-${Environment}-admin-ui-bucket

  AdminUIDistributionId:
    Description: CloudFront distribution ID for Admin UI
    Value: !Ref AdminUIDistribution
    Export:
      Name: !Sub herald-${Environment}-admin-ui-distribution-id

  AdminUIUrl:
    Description: Admin UI URL (CloudFront)
    Value: !Sub "https://${AdminUIDistribution.DomainName}"
    Export:
      Name: !Sub herald-${Environment}-admin-ui-url

  AuroraClusterEndpoint:
    Description: Aurora cluster endpoint for database connections
    Value: !GetAtt AuroraCluster.Endpoint.Address
    Export:
      Name: !Sub herald-${Environment}-aurora-endpoint

  TenantAdminFunctionUrl:
    Description: Lambda Function URL for Tenant Admin
    Value: !GetAtt TenantAdminFunctionUrl.FunctionUrl
    Export:
      Name: !Sub herald-${Environment}-tenant-admin-function-url
